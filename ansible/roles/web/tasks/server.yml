---
# K3S Server installation (master)

- name: Check if K3S is already installed
  ansible.builtin.stat:
    path: /usr/local/bin/k3s
  register: k3s_binary
  tags:
    - k3s
    - server

- name: Create K3S config directory
  ansible.builtin.file:
    path: "{{ k3s_config_dir }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  tags:
    - k3s
    - server

- name: Deploy K3S server configuration
  ansible.builtin.template:
    src: k3s-config.yaml.j2
    dest: "{{ k3s_config_dir }}/config.yaml"
    owner: root
    group: root
    mode: '0644'
  notify: restart k3s
  tags:
    - k3s
    - server
    - config

- name: Download K3S install script
  ansible.builtin.get_url:
    url: https://get.k3s.io
    dest: /tmp/k3s-install.sh
    mode: '0755'
  tags:
    - k3s
    - server

- name: Determine if this is the first master
  ansible.builtin.set_fact:
    k3s_is_first_master: "{{ inventory_hostname == groups['masters'][0] }}"
  tags:
    - k3s
    - server

- name: Install K3S server (first master - cluster init)
  ansible.builtin.shell: |
    {% if k3s_version %}
    INSTALL_K3S_VERSION="{{ k3s_version }}" \
    {% else %}
    INSTALL_K3S_CHANNEL="{{ k3s_channel }}" \
    {% endif %}
    sh /tmp/k3s-install.sh server \
      --cluster-init \
      --tls-san {{ k3s_api_san }} \
      --node-ip {{ k3s_node_ip }} \
      {{ '--flannel-iface ' + k3s_flannel_iface if k3s_flannel_iface else '' }} \
      {{ '--disable traefik' if k3s_disable_traefik else '' }} \
      --write-kubeconfig-mode 644
  args:
    creates: /usr/local/bin/k3s
  when: k3s_is_first_master
  register: k3s_server_install
  changed_when: k3s_server_install.rc == 0
  tags:
    - k3s
    - server

- name: Wait for K3S to be ready (first master)
  ansible.builtin.wait_for:
    path: /var/lib/rancher/k3s/server/node-token
    state: present
    timeout: "{{ k3s_install_timeout }}"
  when: k3s_is_first_master
  tags:
    - k3s
    - server

- name: Fetch node token from first master
  ansible.builtin.slurp:
    src: /var/lib/rancher/k3s/server/node-token
  register: k3s_token_raw
  delegate_to: "{{ groups['masters'][0] }}"
  run_once: true
  tags:
    - k3s
    - server

- name: Set K3S token fact
  ansible.builtin.set_fact:
    k3s_token: "{{ k3s_token_raw.content | b64decode | trim }}"
  run_once: true
  tags:
    - k3s
    - server

- name: Install K3S server (additional masters - join cluster)
  ansible.builtin.shell: |
    {% if k3s_version %}
    INSTALL_K3S_VERSION="{{ k3s_version }}" \
    {% else %}
    INSTALL_K3S_CHANNEL="{{ k3s_channel }}" \
    {% endif %}
    K3S_TOKEN="{{ k3s_token }}" \
    sh /tmp/k3s-install.sh server \
      --server https://{{ k3s_master_ip }}:6443 \
      --tls-san {{ k3s_api_san }} \
      --node-ip {{ k3s_node_ip }} \
      {{ '--flannel-iface ' + k3s_flannel_iface if k3s_flannel_iface else '' }} \
      {{ '--disable traefik' if k3s_disable_traefik else '' }} \
      --write-kubeconfig-mode 644
  args:
    creates: /usr/local/bin/k3s
  when: not k3s_is_first_master
  register: k3s_join_install
  changed_when: k3s_join_install.rc == 0
  tags:
    - k3s
    - server

- name: Wait for K3S service to be active
  ansible.builtin.systemd:
    name: k3s
    state: started
    enabled: yes
  tags:
    - k3s
    - server

- name: Wait for node to be ready
  ansible.builtin.command: kubectl get nodes {{ inventory_hostname }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
  environment:
    KUBECONFIG: "{{ k3s_kubeconfig_path }}"
  register: node_ready
  until: node_ready.stdout == "True"
  retries: 30
  delay: 10
  changed_when: false
  tags:
    - k3s
    - server

- name: Create kubectl symlink
  ansible.builtin.file:
    src: /usr/local/bin/k3s
    dest: /usr/local/bin/kubectl
    state: link
  tags:
    - k3s
    - server

- name: Create crictl symlink
  ansible.builtin.file:
    src: /usr/local/bin/k3s
    dest: /usr/local/bin/crictl
    state: link
  tags:
    - k3s
    - server

- name: Install Helm
  when: k3s_install_helm and k3s_is_first_master
  block:
    - name: Check if Helm is installed
      ansible.builtin.stat:
        path: /usr/local/bin/helm
      register: helm_binary

    - name: Download Helm install script
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        dest: /tmp/get-helm.sh
        mode: '0755'
      when: not helm_binary.stat.exists

    - name: Install Helm
      ansible.builtin.shell: |
        DESIRED_VERSION="{{ helm_version }}" bash /tmp/get-helm.sh
      args:
        creates: /usr/local/bin/helm
      register: helm_install_result
      changed_when: helm_install_result.rc == 0
      when: not helm_binary.stat.exists
  tags:
    - k3s
    - server
    - helm

- name: Create .kube directory for user
  ansible.builtin.file:
    path: "/home/{{ ansible_user }}/.kube"
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'
  when: k3s_is_first_master
  tags:
    - k3s
    - server
    - kubeconfig

- name: Copy kubeconfig to user home
  ansible.builtin.copy:
    src: "{{ k3s_kubeconfig_path }}"
    dest: "/home/{{ ansible_user }}/.kube/config"
    remote_src: yes
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'
  when: k3s_is_first_master
  tags:
    - k3s
    - server
    - kubeconfig

- name: Update kubeconfig server URL for external access
  ansible.builtin.replace:
    path: "/home/{{ ansible_user }}/.kube/config"
    regexp: 'server: https://127.0.0.1:6443'
    replace: 'server: https://{{ k3s_api_san }}:6443'
  when: k3s_is_first_master
  tags:
    - k3s
    - server
    - kubeconfig
